<html lang="cs">
    <head>
        <title>ECI Form debug</title>

        <script>
            window.onerror = function myErrorHandler(err, url, line) {
                //Do some  stuff
                alert(err) // Uncaught SyntaxError: Invalid or unexpected token at Line no:- 1
                return false;   // so you still log errors into console
            }

            if (console.everything === undefined) {
                console.everything = [];
                function TS(){
                    return (new Date).toLocaleString("sv", { timeZone: 'UTC' }) + "Z"
                }
                window.onerror = function (error, url, line) {
                    console.everything.push({
                        type: "exception",
                        timeStamp: TS(),
                        value: { error, url, line }
                    })
                    return false;
                }
                window.onunhandledrejection = function (e) {
                    console.everything.push({
                        type: "promiseRejection",
                        timeStamp: TS(),
                        value: e.reason
                    })
                }

                function hookLogType(logType) {
                    const original= console[logType].bind(console)
                    return function(){
                        console.everything.push({
                            type: logType,
                            timeStamp: TS(),
                            value: Array.from(arguments)
                        })
                        original.apply(console, arguments)
                    }
                }

                ['log', 'error', 'warn', 'debug'].forEach(logType=>{
                    console[logType] = hookLogType(logType)
                })
            }
        </script>
    </head>
    <body>
        <h2>IF YOU DON'T SEE THE ECI FORM BELOW, DO THESE STEPS:</h2>
        <strong>1. Click this button:</strong><button id="submit">I DON'T SEE THE FORM</button>
        <br>
        <strong>2. Copy the text below or do a screenshot and send it to us:</strong>

        <div id="everything" style="border: 1px solid black; background-color: #eee; padding: 0 15px;"></div>

        <hr style="margin-top: 30px; margin-bottom: 10px;">

        <script src="https://sign.furfreeeurope.eu/d/fur_free_europe/svobodazvirat?v=713601355&language=cs"></script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.0/jquery.min.js" integrity="sha512-0nVWK03Ud0k6o8wDkri8jxX9zQIn00ZHVud3iqBTwd2bGFwJDQShGVb3+vX1adCRxQckKQrIQMFmIA3tfWe+Mg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

        <script>
            function recordLogAtHq(message, type, level) {
                var data = {
                    source: 'eci-form-debug',
                    message: message,
                    type: type,
                    level: level,
                };

                var json = JSON.stringify(data)
                var url = "https://ingest.x.tustinarvai.lt/api/ingest/logs"
                var xhr = new XMLHttpRequest()

                xhr.open('POST', url, true)
                xhr.setRequestHeader('Content-type', 'application/json; charset=UTF-8')
                xhr.send(json);

                xhr.onload = function () {
                    console.log('recordLogAtHq: ', xhr.status);
                }
            }

            function recur(obj) {
                var result = {}, _tmp;
                for (var i in obj) {
                    // enabledPlugin is too nested, also skip functions
                    if (i === 'enabledPlugin' || typeof obj[i] === 'function') {
                        continue;
                    } else if (typeof obj[i] === 'object') {
                        // get props recursively
                        _tmp = recur(obj[i]);
                        // if object is not {}
                        if (Object.keys(_tmp).length) {
                            result[i] = _tmp;
                        }
                    } else {
                        // string, number or boolean
                        result[i] = obj[i];
                    }
                }
                return result;
            }

            $(document).ready(function() {
                var $h2 = $('h2');

                // setTimeout(function () {
                //     throw 'asd';
                // }, 1000);

                $('#submit').click(function () {
                    var debugText = JSON.stringify(console.everything, null, 4);
                    var navigatorInfo = JSON.stringify(recur(window.navigator), null, 4);
                    $('#everything').html('<pre><-----------------------\n\r' + debugText + '\n\r-----------------------></pre>');
                    recordLogAtHq(debugText + navigatorInfo, 'debug', 'debug');

                    var randomColor = Math.floor(Math.random()*16777215).toString(16);
                    $h2.css('color', '#' + randomColor);
                });
            });
        </script>
    </body>
</html>
